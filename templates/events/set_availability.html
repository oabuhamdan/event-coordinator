{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Set Availability - {{ organization.name }}{% endblock %}

{% block extra_css %}
<style>
.availability-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 20px;
    padding: 2rem;
}

.org-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 2rem;
}

.availability-form {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.help-section {
    background: #e7f3ff;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="availability-container">
            <!-- Header -->
            <div class="text-center mb-4">
                <i class="fas fa-clock fa-3x text-primary mb-3"></i>
                <h2 class="fw-bold">Set Your Availability</h2>
                <p class="text-muted">Configure when you're available for {{ organization.name }} events</p>
            </div>

            <!-- Organization Info -->
            <div class="org-info">
                {% if organization.logo %}
                    <img src="{{ organization.logo.url }}" alt="{{ organization.name }}"
                         class="img-fluid rounded-circle mb-2" style="max-width: 80px;">
                {% else %}
                    <i class="fas fa-building fa-3x mb-2"></i>
                {% endif %}
                <h4 class="fw-bold">{{ organization.name }}</h4>
                {% if organization.description %}
                    <p class="mb-0">{{ organization.description|truncatechars:150 }}</p>
                {% endif %}
            </div>

            <!-- Availability Form -->
            <div class="availability-form">
                <form method="post" id="availabilityForm">
                    {% csrf_token %}

                    <h5 class="mb-3">
                        <i class="fas fa-calendar-alt me-2"></i>Availability Settings
                    </h5>

                    <!-- Availability Builder -->
                    <div id="availabilityBuilder">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Recurrence Type</label>
                                <select class="form-select" id="recurrenceType">
                                    <option value="weekly">Weekly Pattern</option>
                                    <option value="monthly">Monthly Pattern</option>
                                    <option value="specific">Specific Date</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Availability Type</label>
                                <select class="form-select" id="availabilityType">
                                    <option value="sure">Sure - Definitely Available</option>
                                    <option value="maybe">Maybe - Flexible</option>
                                </select>
                            </div>
                        </div>

                        <!-- Weekly Pattern -->
                        <div id="weeklyPattern" class="pattern-section">
                            <h6 class="fw-bold mb-3">Select Day of the Week</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="dayOfWeek">
                                        <option value="">Select a day...</option>
                                        <option value="0">Monday</option>
                                        <option value="1">Tuesday</option>
                                        <option value="2">Wednesday</option>
                                        <option value="3">Thursday</option>
                                        <option value="4">Friday</option>
                                        <option value="5">Saturday</option>
                                        <option value="6">Sunday</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Pattern -->
                        <div id="monthlyPattern" class="pattern-section" style="display: none;">
                            <h6 class="fw-bold mb-3">Day of Month</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="dayOfMonth" min="1" max="31" placeholder="Day (1-31)">
                                </div>
                            </div>
                        </div>

                        <!-- Specific Date -->
                        <div id="specificPattern" class="pattern-section" style="display: none;">
                            <h6 class="fw-bold mb-3">Specific Date</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="date" class="form-control" id="specificDate">
                                </div>
                            </div>
                        </div>

                        <!-- Time Slots -->
                        <div class="time-selection">
                            <h6 class="fw-bold mb-3">Time Slots</h6>

                            <!-- Current session time slots -->
                            <div id="currentTimeSlots" class="mb-3" style="display: none;">
                                <h6 class="text-muted mb-2">Time slots to add:</h6>
                                <div id="timeSlotsList" class="border rounded p-2 bg-light">
                                    <!-- Dynamic time slots will be added here -->
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="startTime" value="09:00">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="endTime" value="17:00">
                                </div>
                            </div>

                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary me-2" onclick="addTimeSlot()">
                                    <i class="fas fa-plus me-2"></i>Add Time Slot
                                </button>
                                <button type="button" class="btn btn-success" onclick="saveAllTimeSlots()" id="saveAllBtn" style="display: none;">
                                    <i class="fas fa-save me-2"></i>Save All Time Slots
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearTimeSlots()" id="clearBtn" style="display: none;">
                                    <i class="fas fa-trash me-2"></i>Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Current Availability List -->
                    <div class="mt-4">
                        <h6 class="fw-bold">Your Current Availability</h6>
                        <div id="availabilityList" class="border rounded p-3 bg-light">
                            <!-- Dynamic availability entries will be added here -->
                        </div>
                    </div>

                    <!-- Hidden input to store availability data -->
                    <input type="hidden" name="availability_data" id="availabilityData">

                    <!-- Notification Preferences -->
                    <div class="mt-4">
                        <h6 class="fw-bold">Notification Preferences</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="notification_preference"
                                   id="notifyAll" value="all"
                                   {% if subscription.notification_preference == 'all' %}checked{% endif %}>
                            <label class="form-check-label" for="notifyAll">
                                <strong>All Events</strong> - Get notified about every event
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="notification_preference"
                                   id="notifyMatching" value="matching"
                                   {% if subscription.notification_preference == 'matching' %}checked{% endif %}>
                            <label class="form-check-label" for="notifyMatching">
                                <strong>Matching Schedule Only</strong> - Only get notified about events that match your availability
                            </label>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-save me-2"></i>Save Availability
                        </button>
                        <a href="{% url 'organizations:detail' pk=organization.id %}" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Sidebar -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>How It Works
                </h5>
            </div>
            <div class="card-body">
                <div class="help-section">
                    <h6><i class="fas fa-lightbulb me-2 text-warning"></i>Tips:</h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Set weekly patterns for recurring availability
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Use specific dates for special occasions
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            "Sure" means you're definitely available
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            "Maybe" indicates flexible availability
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Current Subscription Info -->
        <div class="card border-0 shadow-sm mt-3">
            <div class="card-header bg-transparent border-0">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Subscription Info
                </h5>
            </div>
            <div class="card-body">
                <p><strong>Subscribed since:</strong><br>{{ subscription.created_at|date:"F j, Y" }}</p>
                <p><strong>Current preference:</strong><br>{{ subscription.get_notification_preference_display }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let availabilityEntries = [];

document.addEventListener('DOMContentLoaded', function() {
    // Pre-populate form with existing availability data
    const availabilityData = {{ availability_json|safe }};
    availabilityEntries = availabilityData || [];

    // Show existing availability
    updateAvailabilityDisplay();

    // Recurrence type change handler
    document.getElementById('recurrenceType').addEventListener('change', function() {
        togglePatternSections();
    });

    // Form submission handler
    const form = document.getElementById('availabilityForm');
    form.addEventListener('submit', function(e) {
        // Update hidden input with availability data
        document.getElementById('availabilityData').value = JSON.stringify(availabilityEntries);
    });
});

function togglePatternSections() {
    const recurrenceType = document.getElementById('recurrenceType').value;

    // Hide all pattern sections
    document.getElementById('weeklyPattern').style.display = 'none';
    document.getElementById('monthlyPattern').style.display = 'none';
    document.getElementById('specificPattern').style.display = 'none';

    // Show selected pattern section
    if (recurrenceType === 'weekly') {
        document.getElementById('weeklyPattern').style.display = 'block';
    } else if (recurrenceType === 'monthly') {
        document.getElementById('monthlyPattern').style.display = 'block';
    } else if (recurrenceType === 'specific') {
        document.getElementById('specificPattern').style.display = 'block';
    }
}

function addAvailability() {
    const recurrenceType = document.getElementById('recurrenceType').value;
    const availabilityType = document.getElementById('availabilityType').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!startTime || !endTime) {
        alert('Please select both start and end times.');
        return;
    }

    if (startTime >= endTime) {
        alert('End time must be after start time.');
        return;
    }

    // Create new time slot
    const newTimeSlot = { start: startTime, end: endTime };

    // Get pattern-specific data
    let patternData = {};
    if (recurrenceType === 'weekly') {
        const dayOfWeek = document.getElementById('dayOfWeek').value;
        if (!dayOfWeek) {
            alert('Please select a day of the week.');
            return;
        }
        patternData.day_of_week = parseInt(dayOfWeek);
    } else if (recurrenceType === 'monthly') {
        const dayOfMonth = document.getElementById('dayOfMonth').value;
        if (!dayOfMonth) {
            alert('Please enter a day of the month.');
            return;
        }
        patternData.day_of_month = parseInt(dayOfMonth);
    } else if (recurrenceType === 'specific') {
        const specificDate = document.getElementById('specificDate').value;
        if (!specificDate) {
            alert('Please select a specific date.');
            return;
        }
        patternData.specific_date = specificDate;
    }

    // Check if we already have an entry for this exact pattern and availability type
    const existingIndex = findExistingEntry(recurrenceType, availabilityType, patternData);

    if (existingIndex !== -1) {
        // Add time slot to existing entry
        availabilityEntries[existingIndex].time_slots.push(newTimeSlot);
        console.log('Added time slot to existing entry:', availabilityEntries[existingIndex]);
    } else {
        // Create new entry
        const newEntry = {
            recurrence_type: recurrenceType,
            availability_type: availabilityType,
            time_slots: [newTimeSlot],
            ...patternData
        };
        availabilityEntries.push(newEntry);
        console.log('Created new entry:', newEntry);
    }

    // Update display
    updateAvailabilityDisplay();

    // Reset only time inputs, keep pattern selection
    document.getElementById('startTime').value = '09:00';
    document.getElementById('endTime').value = '17:00';

    // Show success message
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    let patternText = '';
    if (recurrenceType === 'weekly') {
        patternText = dayNames[patternData.day_of_week];
    } else if (recurrenceType === 'monthly') {
        patternText = `Day ${patternData.day_of_month}`;
    } else {
        patternText = patternData.specific_date;
    }

    alert(`Time slot ${startTime} - ${endTime} added for ${patternText}!`);
}

function findExistingEntry(recurrenceType, availabilityType, patternData) {
    return availabilityEntries.findIndex(entry => {
        // Must match recurrence type and availability type
        if (entry.recurrence_type !== recurrenceType || entry.availability_type !== availabilityType) {
            return false;
        }

        // Check pattern-specific matching
        if (recurrenceType === 'weekly') {
            return entry.day_of_week === patternData.day_of_week;
        } else if (recurrenceType === 'monthly') {
            return entry.day_of_month === patternData.day_of_month;
        } else if (recurrenceType === 'specific') {
            return entry.specific_date === patternData.specific_date;
        }

        return false;
    });
}

function removeTimeSlot(entryIndex, slotIndex) {
    if (availabilityEntries[entryIndex].time_slots.length > 1) {
        // Remove specific time slot
        availabilityEntries[entryIndex].time_slots.splice(slotIndex, 1);
    } else {
        // Remove entire entry if it's the last time slot
        availabilityEntries.splice(entryIndex, 1);
    }
    updateAvailabilityDisplay();
}

function removeAvailability(index) {
    availabilityEntries.splice(index, 1);
    updateAvailabilityDisplay();
}

function updateAvailabilityDisplay() {
    const listContainer = document.getElementById('availabilityList');

    if (availabilityEntries.length === 0) {
        listContainer.innerHTML = '<p class="text-muted mb-0">No availability set yet. Add your first availability above.</p>';
        return;
    }

    let html = '';
    availabilityEntries.forEach((entry, index) => {
        let patternText = '';

        if (entry.recurrence_type === 'weekly') {
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            patternText = `Weekly: ${dayNames[entry.day_of_week]}`;
        } else if (entry.recurrence_type === 'monthly') {
            patternText = `Monthly: Day ${entry.day_of_month}`;
        } else if (entry.recurrence_type === 'specific') {
            patternText = `Specific: ${entry.specific_date}`;
        }

        const typeClass = entry.availability_type === 'sure' ? 'success' : 'warning';
        const typeText = entry.availability_type === 'sure' ? 'Sure' : 'Maybe';

        // Display multiple time slots
        let timeSlotsHtml = '';
        entry.time_slots.forEach((slot, slotIndex) => {
            timeSlotsHtml += `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">${slot.start} - ${slot.end}</small>
                    ${entry.time_slots.length > 1 ?
                        `<button type="button" class="btn btn-xs btn-outline-danger ms-2" onclick="removeTimeSlot(${index}, ${slotIndex})" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;">
                            <i class="fas fa-times"></i>
                        </button>` : ''
                    }
                </div>
            `;
        });

        html += `
            <div class="mb-3 p-3 border rounded bg-white">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <strong>${patternText}</strong>
                            <span class="badge bg-${typeClass} ms-2">${typeText}</span>
                        </div>
                        <div class="time-slots">
                            ${timeSlotsHtml}
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAvailability(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });

    listContainer.innerHTML = html;
}

function resetAvailabilityForm() {
    // Reset dropdowns
    document.getElementById('dayOfWeek').selectedIndex = 0;

    // Reset other inputs
    document.getElementById('dayOfMonth').value = '';
    document.getElementById('specificDate').value = '';
    document.getElementById('startTime').value = '09:00';
    document.getElementById('endTime').value = '17:00';
}

function showLoading() {
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    submitBtn.disabled = true;
}

// Time slot management
let tempTimeSlots = [];

function addTimeSlot() {
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!startTime || !endTime) {
        alert('Please select both start and end times.');
        return;
    }

    if (startTime >= endTime) {
        alert('End time must be after start time.');
        return;
    }

    // Create new time slot
    const newTimeSlot = { start: startTime, end: endTime };

    // Add to temporary list
    tempTimeSlots.push(newTimeSlot);

    // Update display
    updateTimeSlotsDisplay();

    // Show save and clear buttons
    document.getElementById('saveAllBtn').style.display = 'inline-block';
    document.getElementById('clearBtn').style.display = 'inline-block';
}

function updateTimeSlotsDisplay() {
    const timeSlotsList = document.getElementById('timeSlotsList');
    timeSlotsList.innerHTML = '';

    if (tempTimeSlots.length === 0) {
        document.getElementById('currentTimeSlots').style.display = 'none';
        return;
    }

    document.getElementById('currentTimeSlots').style.display = 'block';

    tempTimeSlots.forEach((slot, index) => {
        const slotElement = document.createElement('div');
        slotElement.className = 'd-flex justify-content-between align-items-center mb-1';
        slotElement.innerHTML = `
            <small class="text-muted">${slot.start} - ${slot.end}</small>
            <button type="button" class="btn btn-xs btn-outline-danger ms-2" onclick="removeTempTimeSlot(${index})" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;">
                <i class="fas fa-times"></i>
            </button>
        `;
        timeSlotsList.appendChild(slotElement);
    });
}

function removeTempTimeSlot(index) {
    tempTimeSlots.splice(index, 1);
    updateTimeSlotsDisplay();

    // Hide save and clear buttons if no temp slots left
    if (tempTimeSlots.length === 0) {
        document.getElementById('saveAllBtn').style.display = 'none';
        document.getElementById('clearBtn').style.display = 'none';
    }
}

function saveAllTimeSlots() {
    // Add all temp time slots to the first availability entry
    if (availabilityEntries.length === 0) {
        alert('No existing availability entry found. Please add an availability entry first.');
        return;
    }

    const firstEntry = availabilityEntries[0];

    // Merge temp time slots into the first entry
    firstEntry.time_slots = [...firstEntry.time_slots, ...tempTimeSlots];

    // Clear temp slots
    tempTimeSlots = [];

    // Update display
    updateAvailabilityDisplay();
    updateTimeSlotsDisplay();

    // Hide save and clear buttons
    document.getElementById('saveAllBtn').style.display = 'none';
    document.getElementById('clearBtn').style.display = 'none';

    alert('All time slots saved successfully!');
}

function clearTimeSlots() {
    // Clear temporary time slots
    tempTimeSlots = [];
    updateTimeSlotsDisplay();

    // Hide save and clear buttons
    document.getElementById('saveAllBtn').style.display = 'none';
    document.getElementById('clearBtn').style.display = 'none';
}
</script>
{% endblock %}
